<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>H-Yun盘 分享访问</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
    :root { --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#6b7280; --border:#1f2937; --primary:#3b82f6; }
    *{box-sizing:border-box} body{margin:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text)}
    .app{max-width:640px;margin:0 auto;padding:20px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:14px}
    .row{display:flex;gap:10px;align-items:center}
    .btn{background:#0b1220;border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer;font-size:14px;transition:all 0.2s}
    .btn:hover{background:var(--primary);border-color:var(--primary)}
    .btn.primary{background:var(--primary);border-color:var(--primary)}
    .input{background:#0b1220;border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:8px;font-size:14px;width:100%}
    .muted{color:var(--muted)}
    .toast{position:fixed;right:16px;bottom:16px;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px 12px;display:none}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center}
    .modal .card{width:360px}
    .file-info{margin-bottom:12px}
    .file-info .file-name{font-size:16px;font-weight:500;margin-bottom:4px}
    .file-info .file-meta{font-size:14px;color:var(--muted)}
    .preview-container{text-align:center;margin:20px 0;padding:20px;background:#0a0f1a;border-radius:8px;border:1px solid var(--border)}
    .preview-image{max-width:100%;max-height:70vh;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
    .preview-error{color:var(--muted);padding:40px;font-style:italic}
    .action-buttons{display:flex;gap:8px;justify-content:center;margin-top:16px}
  </style>
  <script>
    function el(id){ return document.getElementById(id); }
    function showToast(msg){ const t=el('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>{t.style.display='none'},2200); }
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showToast('链接已复制到剪贴板');
      }).catch(() => {
        showToast('复制失败，请手动复制');
      });
    }
    function getUUID(){ const p=location.pathname; const m=p.match(/\/share\/(.+)$/); return m?m[1]:''; }
    function openPwdModal(){
      const m = el('pwd-modal'); m.style.display='flex';
      setTimeout(()=>{ el('modal-password').focus(); }, 0);
    }
    function closePwdModal(){ el('pwd-modal').style.display='none'; }
    function isImageFile(filename) {
      const ext = filename.toLowerCase().split('.').pop();
      return ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'].includes(ext);
    }
    async function init(){
      const uuid = getUUID(); if(!uuid){ el('content').innerHTML = '<div class="muted">无效的链接</div>'; return; }
      try {
        const r = await fetch('/api/shares/check/' + uuid);
        const data = await r.json();
        if (!r.ok) { el('content').innerHTML = `<div class="muted">${data.error || '分享不可用'}</div>`; return; }
        el('name').textContent = data.name || '(未知)';
        el('expire').textContent = data.isPermanent ? '永久' : (data.expireAt || '-');
        const hasPwd = !!data.hasPassword;
        el('pwd-wrap').style.display = hasPwd ? 'block' : 'none';
        if (hasPwd) openPwdModal();
        
        // 如果是图片文件，直接显示图片预览
        if (isImageFile(data.name || '')) {
          showImagePreview(uuid, data.name, hasPwd);
        } else {
          el('download').onclick = () => access(uuid, false);
          el('preview').onclick = () => access(uuid, true);
        }
        
        el('modal-cancel').onclick = closePwdModal;
        el('modal-confirm').onclick = () => { el('password').value = el('modal-password').value; closePwdModal(); showImagePreview(uuid, data.name, false); };
      } catch(err){ el('content').innerHTML = `<div class="muted">加载失败：${err}</div>`; }
    }
    async function showImagePreview(uuid, filename, needPassword) {
      if (needPassword && !el('password').value) {
        return; // 等待用户输入密码
      }
      
      const pwdEl = el('password');
      const pwd = pwdEl && pwdEl.value ? pwdEl.value : '';
      
      // 构建图片URL
      const params = new URLSearchParams();
      if (pwd) params.set('password', pwd);
      params.set('inline', '1');
      const imageUrl = '/api/shares/access/' + uuid + (params.toString() ? ('?' + params.toString()) : '');
      
      // 替换页面内容为图片预览
       const content = el('content');
       content.innerHTML = `
         <div class="file-info">
           <div class="file-name">${filename}</div>
           <div class="file-meta">图片文件 • 点击图片可查看原图</div>
         </div>
         <div class="preview-container">
           <img src="${imageUrl}" alt="${filename}" class="preview-image" 
                onclick="window.open('${imageUrl}', '_blank')"
                style="cursor: pointer;"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
           <div class="preview-error" style="display: none;">图片加载失败</div>
         </div>
         <div class="action-buttons">
           <button class="btn" onclick="window.open('${imageUrl.replace('inline=1', '')}', '_blank')">
             <i class="fas fa-download"></i> 下载原图
           </button>
           <button class="btn" onclick="copyToClipboard('${window.location.href}')">
             <i class="fas fa-copy"></i> 复制链接
           </button>
         </div>
       `;
    }
    async function access(uuid, inline){
      const pwdEl = el('password');
      const pwd = pwdEl && pwdEl.value ? pwdEl.value : '';
      // 先校验密码，避免直接跳转到错误页
      try {
        const vr = await fetch('/api/shares/verify/' + uuid + (pwd ? ('?password=' + encodeURIComponent(pwd)) : ''));
        const vj = await vr.json().catch(()=>({}));
        if (!vr.ok) { showToast(vj.error || '密码错误'); return; }
      } catch(err){ showToast('验证失败：' + err); return; }

      const params = new URLSearchParams();
      if (pwd) params.set('password', pwd);
      if (inline) params.set('inline','1');
      const url = '/api/shares/access/' + uuid + (params.toString() ? ('?' + params.toString()) : '');
      window.location.href = url;
    }
    document.addEventListener('DOMContentLoaded', init);
  </script>
</head>
<body>
  <div class="app">
    <h2>分享访问</h2>
    <div class="card" id="content">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div>名称：<span id="name">-</span></div>
          <div class="muted">过期时间：<span id="expire">-</span></div>
        </div>
      </div>
      <div id="pwd-wrap" style="margin-top:12px; display:none;">
        <div class="muted">请输入访问密码</div>
        <input class="input" id="password" placeholder="访问密码" />
      </div>
      <div class="row" style="margin-top:12px;">
        <button class="btn" id="download">下载</button>
        <button class="btn" id="preview">预览</button>
      </div>
    </div>
  </div>
  <div class="modal" id="pwd-modal">
    <div class="card">
      <div class="muted" style="margin-bottom:8px;">请输入访问密码</div>
      <input class="input" id="modal-password" placeholder="访问密码" />
      <div class="row" style="margin-top:10px; justify-content:flex-end;">
        <button class="btn" id="modal-cancel">取消</button>
        <button class="btn" id="modal-confirm">确认</button>
      </div>
    </div>
  </div>
  <div class="toast" id="toast"></div>
</body>
</html>